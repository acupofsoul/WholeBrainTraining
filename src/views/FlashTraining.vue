<template>
  <div class="flash-training-container">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <div class="breadcrumb-nav" v-if="$route.path !== '/flash-training'">
      <span class="breadcrumb-item" @click="goBack">
        <span class="back-arrow">â†</span>
        é—ªè§†è®­ç»ƒ
      </span>
      <span class="breadcrumb-separator">></span>
      <span class="breadcrumb-current">{{ getModuleTitle($route.path) }}</span>
    </div>

    <!-- ä¸»é¡µé¢å†…å®¹ -->
    <div v-if="$route.path === '/flash-training'">
      <div class="page-header">
        <h1>é—ªè§†è®­ç»ƒ</h1>
        <p class="page-description">
          é—ªè§†è®­ç»ƒæ˜¯ä¸ƒç”°çœŸå…¨è„‘å¼€å‘çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€šè¿‡å¿«é€Ÿé—ªç°çš„è§†è§‰åˆºæ¿€ï¼Œ
          æ¿€æ´»å³è„‘çš„å›¾åƒå¤„ç†èƒ½åŠ›ï¼Œæå‡ç¬é—´è®°å¿†å’Œä¿¡æ¯å¤„ç†é€Ÿåº¦ã€‚
        </p>
      </div>

      <div class="training-modules">
        <div class="module-card" @click="navigateTo('basic-flash')">
          <div class="module-icon">âš¡</div>
          <h3>åŸºæœ¬é—ªè§†è®­ç»ƒ</h3>
          <p>é€šè¿‡åŸºç¡€å›¾å½¢ã€æ•°å­—ã€å­—æ¯çš„å¿«é€Ÿé—ªç°ï¼Œå»ºç«‹é—ªè§†æ„ŸçŸ¥åŸºç¡€</p>
          <div class="module-level">éš¾åº¦ï¼šâ­</div>
          <div class="module-stats">
            <span>å·²å®Œæˆï¼š{{ basicFlashStats.completed }}æ¬¡</span>
            <span>æœ€ä½³æˆç»©ï¼š{{ basicFlashStats.bestScore }}%</span>
          </div>
        </div>

        <div class="module-card" @click="navigateTo('article-flash')">
          <div class="module-icon">ğŸ“„</div>
          <h3>æ–‡ç« é—ªè§†è®­ç»ƒ</h3>
          <p>å¿«é€Ÿé—ªç°æ–‡ç« æ®µè½ï¼Œè®­ç»ƒæ–‡å­—ä¿¡æ¯çš„ç¬é—´æ•æ‰å’Œç†è§£èƒ½åŠ›</p>
          <div class="module-level">éš¾åº¦ï¼šâ­â­â­</div>
          <div class="module-stats">
            <span>å·²å®Œæˆï¼š{{ articleFlashStats.completed }}æ¬¡</span>
            <span>æœ€ä½³æˆç»©ï¼š{{ articleFlashStats.bestScore }}%</span>
          </div>
        </div>

        <div class="module-card" @click="navigateTo('image-flash')">
          <div class="module-icon">ğŸ–¼ï¸</div>
          <h3>å›¾åƒé—ªè§†è®­ç»ƒ</h3>
          <p>é€šè¿‡å¤æ‚å›¾åƒçš„å¿«é€Ÿé—ªç°ï¼Œæå‡è§†è§‰è®°å¿†å’Œå›¾åƒè¯†åˆ«èƒ½åŠ›</p>
          <div class="module-level">éš¾åº¦ï¼šâ­â­</div>
          <div class="module-stats">
            <span>å·²å®Œæˆï¼š{{ imageFlashStats.completed }}æ¬¡</span>
            <span>æœ€ä½³æˆç»©ï¼š{{ imageFlashStats.bestScore }}%</span>
          </div>
        </div>

        <div class="module-card" @click="navigateTo('custom-word-flash')">
          <div class="module-icon">ğŸ“</div>
          <h3>è‡ªå®šä¹‰å•è¯é—ªè§†</h3>
          <p>è‡ªå®šä¹‰å•è¯åˆ—è¡¨è¿›è¡Œé—ªè§†è®­ç»ƒï¼Œæ”¯æŒä¸ªæ€§åŒ–å­¦ä¹ å†…å®¹</p>
          <div class="module-level special">è‡ªå®šä¹‰</div>
          <div class="module-stats">
            <span>å·²å®Œæˆï¼š{{ customWordStats.completed }}æ¬¡</span>
            <span>æœ€ä½³æˆç»©ï¼š{{ customWordStats.bestScore }}%</span>
          </div>
        </div>

        <div class="module-card" @click="navigateTo('custom-image-flash')">
          <div class="module-icon">ğŸ¨</div>
          <h3>è‡ªå®šä¹‰å›¾ç‰‡é—ªè§†</h3>
          <p>ä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡è¿›è¡Œé—ªè§†è®­ç»ƒï¼Œæ”¯æŒå¤šç»„å›¾ç‰‡æ‰¹é‡è®¾ç½®</p>
          <div class="module-level special">è‡ªå®šä¹‰</div>
          <div class="module-stats">
            <span>å·²å®Œæˆï¼š{{ customImageStats.completed }}æ¬¡</span>
            <span>æœ€ä½³æˆç»©ï¼š{{ customImageStats.bestScore }}%</span>
          </div>
        </div>
      </div>

    <div class="training-settings">
      <h3>è®­ç»ƒè®¾ç½®</h3>
      <div class="settings-grid">
        <div class="setting-item">
          <label>é—ªç°é€Ÿåº¦</label>
          <select v-model="flashSpeed">
            <option value="slow">æ…¢é€Ÿ (1000ms)</option>
            <option value="medium">ä¸­é€Ÿ (500ms)</option>
            <option value="fast">å¿«é€Ÿ (200ms)</option>
            <option value="ultra">æé€Ÿ (100ms)</option>
          </select>
        </div>
        
        <div class="setting-item">
          <label>è®­ç»ƒè½®æ•°</label>
          <select v-model="trainingRounds">
            <option value="5">5è½®</option>
            <option value="10">10è½®</option>
            <option value="15">15è½®</option>
            <option value="20">20è½®</option>
          </select>
        </div>
        
        <div class="setting-item">
          <label>éš¾åº¦ç­‰çº§</label>
          <select v-model="difficultyLevel">
            <option value="beginner">åˆçº§</option>
            <option value="intermediate">ä¸­çº§</option>
            <option value="advanced">é«˜çº§</option>
          </select>
        </div>
        
        <div class="setting-item">
          <label>å£°éŸ³æç¤º</label>
          <div class="toggle-switch">
            <input type="checkbox" v-model="soundEnabled" id="sound-toggle">
            <label for="sound-toggle" class="toggle-label"></label>
          </div>
        </div>
      </div>
    </div>

    <div class="progress-overview">
      <h3>è®­ç»ƒè¿›åº¦æ¦‚è§ˆ</h3>
      <div class="progress-charts">
        <div class="chart-item">
          <div class="chart-circle">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="#e0e0e0" stroke-width="8"/>
              <circle 
                cx="50" 
                cy="50" 
                r="45" 
                fill="none" 
                stroke="var(--color-primary)" 
                stroke-width="8"
                stroke-dasharray="283"
                :stroke-dashoffset="283 - (283 * overallProgress / 100)"
                transform="rotate(-90 50 50)"
              />
            </svg>
            <div class="chart-text">
              <span class="percentage">{{ Math.round(overallProgress) }}%</span>
              <span class="label">æ€»ä½“è¿›åº¦</span>
            </div>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number">{{ totalSessions }}</div>
            <div class="stat-label">æ€»è®­ç»ƒæ¬¡æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ averageAccuracy }}%</div>
            <div class="stat-label">å¹³å‡å‡†ç¡®ç‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ bestStreak }}</div>
            <div class="stat-label">æœ€ä½³è¿å‡»</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ totalTime }}min</div>
            <div class="stat-label">ç´¯è®¡è®­ç»ƒæ—¶é—´</div>
          </div>
        </div>
      </div>
    </div>

    <div class="training-tips">
      <h3>è®­ç»ƒå°è´´å£«</h3>
      <div class="tips-grid">
        <div class="tip-item">
          <div class="tip-icon">ğŸ’¡</div>
          <h4>æ”¾æ¾çŠ¶æ€</h4>
          <p>ä¿æŒèº«å¿ƒæ”¾æ¾ï¼Œä¸è¦è¿‡åº¦ç´§å¼ ï¼Œè®©å¤§è„‘è‡ªç„¶æ¥æ”¶ä¿¡æ¯</p>
        </div>
        <div class="tip-item">
          <div class="tip-icon">ğŸ‘ï¸</div>
          <h4>ä¸“æ³¨ä¸­å¿ƒ</h4>
          <p>è§†çº¿é›†ä¸­åœ¨å±å¹•ä¸­å¤®ï¼Œç”¨ä½™å…‰æ„ŸçŸ¥æ•´ä½“ä¿¡æ¯</p>
        </div>
        <div class="tip-item">
          <div class="tip-icon">ğŸ¯</div>
          <h4>å¾ªåºæ¸è¿›</h4>
          <p>ä»æ…¢é€Ÿå¼€å§‹ï¼Œé€æ­¥æé«˜é—ªç°é€Ÿåº¦å’Œéš¾åº¦</p>
        </div>
        <div class="tip-item">
          <div class="tip-icon">â°</div>
          <h4>å®šæœŸç»ƒä¹ </h4>
          <p>æ¯å¤©åšæŒç»ƒä¹ 15-20åˆ†é’Ÿï¼Œæ•ˆæœæ›´ä½³</p>
        </div>
      </div>
    </div>

    </div>

    <!-- å­è·¯ç”±å†…å®¹ -->
    <router-view v-if="$route.path !== '/flash-training'" />
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { useTrainingStore } from '../stores';

const router = useRouter();
const route = useRoute();
const trainingStore = useTrainingStore();

// æ¨¡å—æ ‡é¢˜æ˜ å°„
const moduleTitles = {
  '/flash-training/basic-flash': 'åŸºæœ¬é—ªè§†è®­ç»ƒ',
  '/flash-training/article-flash': 'æ–‡ç« é—ªè§†è®­ç»ƒ',
  '/flash-training/image-flash': 'å›¾åƒé—ªè§†è®­ç»ƒ',
  '/flash-training/custom-word-flash': 'è‡ªå®šä¹‰å•è¯é—ªè§†',
  '/flash-training/custom-image-flash': 'è‡ªå®šä¹‰å›¾ç‰‡é—ªè§†'
};

// è·å–æ¨¡å—æ ‡é¢˜
const getModuleTitle = (path) => {
  return moduleTitles[path] || 'é—ªè§†è®­ç»ƒ';
};

// è®­ç»ƒè®¾ç½®
const flashSpeed = ref('medium');
const trainingRounds = ref('10');
const difficultyLevel = ref('beginner');
const soundEnabled = ref(true);

// ç»Ÿè®¡æ•°æ®
const overallProgress = ref(0);
const totalSessions = ref(0);
const averageAccuracy = ref(0);
const bestStreak = ref(0);
const totalTime = ref(0);

// å„æ¨¡å—ç»Ÿè®¡
const basicFlashStats = ref({ completed: 0, bestScore: 0 });
const articleFlashStats = ref({ completed: 0, bestScore: 0 });
const imageFlashStats = ref({ completed: 0, bestScore: 0 });
const customWordStats = ref({ completed: 0, bestScore: 0 });
const customImageStats = ref({ completed: 0, bestScore: 0 });

// å¯¼èˆªåˆ°æŒ‡å®šæ¨¡å—
const navigateTo = (moduleKey) => {
  // ä¿å­˜å½“å‰è®¾ç½®
  saveSettings();
  router.push(`/flash-training/${moduleKey}`);
};

// è¿”å›ä¸»è§†å›¾
const goBack = () => {
  router.push('/flash-training');
};

// ä¿å­˜è®¾ç½®
const saveSettings = () => {
  const settings = {
    flashSpeed: flashSpeed.value,
    trainingRounds: trainingRounds.value,
    difficultyLevel: difficultyLevel.value,
    soundEnabled: soundEnabled.value
  };
  localStorage.setItem('flashTrainingSettings', JSON.stringify(settings));
};

// åŠ è½½è®¾ç½®
const loadSettings = () => {
  const saved = localStorage.getItem('flashTrainingSettings');
  if (saved) {
    const settings = JSON.parse(saved);
    flashSpeed.value = settings.flashSpeed || 'medium';
    trainingRounds.value = settings.trainingRounds || '10';
    difficultyLevel.value = settings.difficultyLevel || 'beginner';
    soundEnabled.value = settings.soundEnabled !== false;
  }
};

// åŠ è½½è®­ç»ƒæ•°æ®
const loadTrainingData = () => {
  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½é—ªè§†è®­ç»ƒæ•°æ®
  const saved = localStorage.getItem('flashTrainingStats');
  if (saved) {
    const flashStats = JSON.parse(saved);
    overallProgress.value = flashStats.overallProgress || 0;
    totalSessions.value = flashStats.totalSessions || 0;
    averageAccuracy.value = flashStats.averageAccuracy || 0;
    bestStreak.value = flashStats.bestStreak || 0;
    totalTime.value = flashStats.totalTime || 0;
    
    // åŠ è½½å„æ¨¡å—æ•°æ®
    basicFlashStats.value = flashStats.basicFlash || { completed: 0, bestScore: 0 };
    articleFlashStats.value = flashStats.articleFlash || { completed: 0, bestScore: 0 };
    imageFlashStats.value = flashStats.imageFlash || { completed: 0, bestScore: 0 };
    customWordStats.value = flashStats.customWord || { completed: 0, bestScore: 0 };
    customImageStats.value = flashStats.customImage || { completed: 0, bestScore: 0 };
  } else {
    // åˆå§‹åŒ–é»˜è®¤æ•°æ®
    overallProgress.value = 0;
    totalSessions.value = 0;
    averageAccuracy.value = 0;
    bestStreak.value = 0;
    totalTime.value = 0;
    basicFlashStats.value = { completed: 0, bestScore: 0 };
    articleFlashStats.value = { completed: 0, bestScore: 0 };
    imageFlashStats.value = { completed: 0, bestScore: 0 };
    customWordStats.value = { completed: 0, bestScore: 0 };
    customImageStats.value = { completed: 0, bestScore: 0 };
  }
};



onMounted(() => {
  loadSettings();
  loadTrainingData();
});
</script>

<style scoped>
.flash-training-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

/* é¢åŒ…å±‘å¯¼èˆªæ ·å¼ - ç´§å‡‘è®¾è®¡ */
.breadcrumb-nav {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  padding: 0.5rem 1rem;
  background: rgba(248, 250, 252, 0.8);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(226, 232, 240, 0.6);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  font-size: 0.875rem;
}

.breadcrumb-item {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  background: #3b82f6;
  color: white;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
}

.breadcrumb-item:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
}

.back-arrow {
  font-size: 0.9rem;
  font-weight: bold;
}

.breadcrumb-separator {
  color: #94a3b8;
  font-size: 0.9rem;
  opacity: 0.6;
  margin: 0 0.1rem;
}

.breadcrumb-current {
  color: #1e40af;
  font-weight: 600;
  font-size: 0.8rem;
  padding: 0.4rem 0.8rem;
  background: rgba(59, 130, 246, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.15);
  border-radius: 6px;
}

/* æ¨¡å—å†…å®¹æ ·å¼ */
.module-content {
  min-height: 60vh;
}

.page-header {
  text-align: center;
  margin-bottom: 3rem;
}

.page-header h1 {
  color: var(--color-primary);
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

.page-description {
  font-size: 1.1rem;
  color: var(--color-text-secondary);
  line-height: 1.6;
  max-width: 800px;
  margin: 0 auto;
}

.training-modules {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-bottom: 3rem;
}

.module-card {
  background: var(--color-card-bg);
  border-radius: 12px;
  padding: 1.5rem;
  cursor: pointer;
  transition: all var(--transition-normal) ease;
  box-shadow: var(--shadow-md);
  border: 2px solid transparent;
}

.module-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
  border-color: var(--color-primary);
}

.module-icon {
  font-size: 2.5rem;
  text-align: center;
  margin-bottom: 1rem;
}

.module-card h3 {
  color: var(--color-primary);
  margin-bottom: 0.8rem;
  font-size: 1.2rem;
}

.module-card p {
  color: var(--color-text-secondary);
  margin-bottom: 1rem;
  line-height: 1.4;
  font-size: 0.95rem;
}

.module-level {
  background: rgba(var(--color-warning-rgb), 0.1);
  color: var(--color-warning);
  padding: 0.4rem 0.8rem;
  border-radius: 15px;
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 1rem;
}

.module-level.special {
  background: linear-gradient(135deg, rgba(139, 69, 19, 0.1) 0%, rgba(160, 82, 45, 0.1) 100%);
  color: #8b4513;
  border: 1px solid rgba(139, 69, 19, 0.2);
  position: relative;
  overflow: hidden;
}

.module-level.special::before {
  content: 'âœ¨';
  margin-right: 0.3rem;
}

.module-stats {
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.module-stats span {
  font-size: 0.85rem;
  color: var(--color-text-secondary);
}

.training-settings {
  background: var(--color-card-bg);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 3rem;
  box-shadow: var(--shadow-md);
}

.training-settings h3 {
  color: var(--color-primary);
  margin-bottom: 1.5rem;
}

.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.setting-item {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.setting-item label {
  font-weight: 600;
  color: var(--color-text);
  font-size: 0.9rem;
}

.setting-item select {
  padding: 0.8rem;
  border: 2px solid var(--color-border);
  border-radius: 8px;
  background: var(--color-bg);
  color: var(--color-text);
  font-size: 0.9rem;
  transition: border-color var(--transition-normal);
}

.setting-item select:focus {
  outline: none;
  border-color: var(--color-primary);
}

.toggle-switch {
  position: relative;
  display: inline-block;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-label {
  display: block;
  width: 50px;
  height: 24px;
  background: var(--color-border);
  border-radius: 12px;
  cursor: pointer;
  transition: background var(--transition-normal);
  position: relative;
}

.toggle-label::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: white;
  top: 2px;
  left: 2px;
  transition: transform var(--transition-normal);
}

.toggle-switch input:checked + .toggle-label {
  background: var(--color-primary);
}

.toggle-switch input:checked + .toggle-label::after {
  transform: translateX(26px);
}

.progress-overview {
  background: var(--color-card-bg);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 3rem;
  box-shadow: var(--shadow-md);
}

.progress-overview h3 {
  color: var(--color-primary);
  margin-bottom: 2rem;
  text-align: center;
}

.progress-charts {
  display: grid;
  grid-template-columns: 200px 1fr;
  gap: 2rem;
  align-items: center;
}

.chart-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.chart-circle svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.chart-circle circle {
  transition: stroke-dashoffset 1s ease;
}

.chart-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.percentage {
  display: block;
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--color-primary);
}

.label {
  font-size: 0.8rem;
  color: var(--color-text-secondary);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}

.stat-item {
  text-align: center;
  padding: 1rem;
  background: rgba(var(--color-primary-rgb), 0.05);
  border-radius: 8px;
}

.stat-number {
  font-size: 1.8rem;
  font-weight: 600;
  color: var(--color-primary);
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.85rem;
  color: var(--color-text-secondary);
}

.training-tips {
  background: var(--color-card-bg);
  border-radius: 12px;
  padding: 2rem;
  box-shadow: var(--shadow-md);
}

.training-tips h3 {
  color: var(--color-primary);
  margin-bottom: 1.5rem;
  text-align: center;
}

.tips-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
}

.tip-item {
  text-align: center;
  padding: 1.5rem;
  background: rgba(var(--color-primary-rgb), 0.05);
  border-radius: 8px;
}

.tip-icon {
  font-size: 2rem;
  margin-bottom: 1rem;
}

.tip-item h4 {
  color: var(--color-primary);
  margin-bottom: 0.8rem;
  font-size: 1.1rem;
}

.tip-item p {
  color: var(--color-text-secondary);
  font-size: 0.9rem;
  line-height: 1.4;
  margin: 0;
}

@media (max-width: 768px) {
  .flash-training-container {
    padding: 1rem;
  }
  
  .page-header h1 {
    font-size: 2rem;
  }
  
  .training-modules {
    grid-template-columns: 1fr;
  }
  
  .settings-grid {
    grid-template-columns: 1fr;
  }
  
  .progress-charts {
    grid-template-columns: 1fr;
    text-align: center;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .tips-grid {
    grid-template-columns: 1fr;
  }
}
</style>