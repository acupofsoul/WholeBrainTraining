import{G as R,H as ne,I as E,J as se,i as m,D as h,c as f,k as oe,A as re}from"./index-e0b54b24.js";const p=t=>{const n={soundEffects:!0,vibration:!1,showProgress:!0,autoNext:!1,theme:"default"};return{overall_perception:{...n,defaultDifficulty:"medium",trainingDuration:300,stimulusCount:20,responseTime:3e3},expand_vision:{...n,defaultLevel:1,displayTime:1e3,gridSize:3,contentType:"numbers"},reading_rhythm:{...n,defaultBPM:120,rhythmType:"simple",visualMetronome:!0,audioMetronome:!0},fluency:{...n,defaultSpeed:"medium",textComplexity:"medium",evaluationMode:"comprehensive"},attention:{...n,defaultMode:"focus",sessionDuration:300,difficultyLevel:"medium"},schulte_table:{...n,gridSize:5,contentType:"numbers",colorMode:"monochrome",highlightNext:!1}}[t]||n},w=()=>({totalSessions:0,totalTime:0,bestScore:null,averageScore:null,lastSession:null,completionRate:0,improvementTrend:[],achievements:[],weeklyProgress:[],monthlyProgress:[]});async function I(t){try{const n=await R(),e=`basicTraining_${t}`;return n[e]?{...p(t),...n[e]}:p(t)}catch(n){return console.error(`获取${t}模块设置失败:`,n),p(t)}}async function A(t,n){try{const e=await R(),i=`basicTraining_${t}`;return e[i]={...p(t),...n,lastUpdated:new Date().toISOString()},await ne(e),!0}catch(e){return console.error(`保存${t}模块设置失败:`,e),!1}}async function K(t){try{const n=await E(),e=`basicTraining_${t}`;return n.moduleStats&&n.moduleStats[e]?{...w(),...n.moduleStats[e]}:w()}catch(n){return console.error(`获取${t}模块统计数据失败:`,n),w()}}async function N(t,n){try{const e=await E(),i=`basicTraining_${t}`;return e.moduleStats||(e.moduleStats={}),e.moduleStats[i]={...w(),...n,lastUpdated:new Date().toISOString()},await se(e),!0}catch(e){return console.error(`保存${t}模块统计数据失败:`,e),!1}}async function ie(t,n){try{const e=await K(t);if(e.totalSessions+=1,e.totalTime+=n.duration||0,e.lastSession=new Date().toISOString(),n.score!==void 0&&((!e.bestScore||n.score>e.bestScore)&&(e.bestScore=n.score),e.averageScore?e.averageScore=(e.averageScore*(e.totalSessions-1)+n.score)/e.totalSessions:e.averageScore=n.score),n.completed!==void 0){const o=e.totalSessions*e.completionRate/100+(n.completed?1:0);e.completionRate=o/e.totalSessions*100}return e.improvementTrend.push({date:new Date().toISOString(),score:n.score,duration:n.duration,completed:n.completed}),e.improvementTrend.length>20&&(e.improvementTrend=e.improvementTrend.slice(-20)),ae(e,n),ce(e,n),le(e,n),await N(t,e),e}catch(e){throw console.error(`更新${t}模块训练记录失败:`,e),e}}function ae(t,n){const e=new Date,o=new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay()).toISOString().split("T")[0];let s=t.weeklyProgress.find(c=>c.week===o);s||(s={week:o,sessions:0,totalTime:0,averageScore:0,completedSessions:0},t.weeklyProgress.push(s)),s.sessions+=1,s.totalTime+=n.duration||0,n.completed&&(s.completedSessions+=1),n.score!==void 0&&(s.averageScore=(s.averageScore*(s.sessions-1)+n.score)/s.sessions),t.weeklyProgress.length>12&&(t.weeklyProgress=t.weeklyProgress.slice(-12))}function ce(t,n){const e=new Date,i=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`;let o=t.monthlyProgress.find(s=>s.month===i);o||(o={month:i,sessions:0,totalTime:0,averageScore:0,completedSessions:0},t.monthlyProgress.push(o)),o.sessions+=1,o.totalTime+=n.duration||0,n.completed&&(o.completedSessions+=1),n.score!==void 0&&(o.averageScore=(o.averageScore*(o.sessions-1)+n.score)/o.sessions),t.monthlyProgress.length>12&&(t.monthlyProgress=t.monthlyProgress.slice(-12))}function le(t,n){[{id:"first_session",name:"初次体验",description:"完成第一次训练",condition:()=>t.totalSessions===1},{id:"ten_sessions",name:"坚持不懈",description:"完成10次训练",condition:()=>t.totalSessions===10},{id:"hundred_sessions",name:"百炼成钢",description:"完成100次训练",condition:()=>t.totalSessions===100},{id:"perfect_score",name:"完美表现",description:"获得满分成绩",condition:()=>n.score===100},{id:"one_hour_total",name:"时间投入",description:"累计训练1小时",condition:()=>t.totalTime>=3600},{id:"ten_hours_total",name:"专注训练",description:"累计训练10小时",condition:()=>t.totalTime>=36e3}].forEach(i=>{i.condition()&&!t.achievements.find(o=>o.id===i.id)&&t.achievements.push({id:i.id,name:i.name,description:i.description,unlockedAt:new Date().toISOString()})})}function de(t,n={}){const e=m(!0),i=h({}),o=h({}),s=h({startTime:null,endTime:null,duration:0,score:null,completed:!1,errors:0,data:{}}),c=m(!1),a=m(!1),g=m(null),b=m(""),C=m(0),P=h({}),U=f(()=>({totalSessions:o.totalSessions||0,totalTimeFormatted:k(o.totalTime||0),bestScore:o.bestScore||0,averageScore:Math.round((o.averageScore||0)*100)/100,completionRate:Math.round((o.completionRate||0)*100)/100,recentTrend:_(),achievements:o.achievements||[],weeklyData:o.weeklyProgress||[],monthlyData:o.monthlyProgress||[]})),B=f(()=>s.startTime?s.duration:0),z=f(()=>!c.value&&!e.value),F=f(()=>c.value&&!a.value),H=f(()=>c.value&&a.value);async function D(){try{e.value=!0;const r=await I(t);Object.assign(i,{...r,...n});const l=await K(t);Object.assign(o,l),Object.assign(P,{basic:0,intermediate:0,advanced:0,expert:0,speed_fluency:0,comprehension_fluency:0,contextual_reading:0})}catch(r){console.error(`初始化${t}模块失败:`,r)}finally{e.value=!1}}async function L(r){try{return Object.assign(i,r),await A(t,i),!0}catch(l){return console.error(`保存${t}模块设置失败:`,l),!1}}function M(r={}){if(c.value){console.warn("训练已在进行中");return}Object.assign(s,{startTime:new Date,endTime:null,duration:0,score:null,completed:!1,errors:0,data:{...r}}),c.value=!0,a.value=!1,$(),console.log(`开始${t}训练会话`)}function V(){!c.value||a.value||(a.value=!0,v(),console.log(`暂停${t}训练`))}function Y(){!c.value||!a.value||(a.value=!1,$(),console.log(`恢复${t}训练`))}async function T(r={}){if(!c.value){console.warn("没有进行中的训练会话");return}v(),s.endTime=new Date,s.duration=Math.floor((s.endTime-s.startTime)/1e3),Object.assign(s,r);try{const l=await ie(t,{duration:s.duration,score:s.score,completed:s.completed,errors:s.errors,sessionData:s.data,timestamp:s.endTime.toISOString()});Object.assign(o,l),console.log(`${t}训练会话已结束并保存`)}catch(l){console.error(`保存${t}训练记录失败:`,l)}c.value=!1,a.value=!1}function G(){c.value&&(v(),c.value=!1,a.value=!1,Object.assign(s,{startTime:null,endTime:null,duration:0,score:null,completed:!1,errors:0,data:{}}),console.log(`取消${t}训练会话`))}function J(r){Object.assign(s.data,r)}function W(r=1){s.errors+=r}function q(r){s.score=r}function Q(r=!0){s.completed=r}function $(){g.value&&clearInterval(g.value),g.value=setInterval(()=>{s.startTime&&!a.value&&(s.duration=Math.floor((new Date-s.startTime)/1e3))},1e3)}function v(){g.value&&(clearInterval(g.value),g.value=null)}function k(r){const l=Math.floor(r/3600),u=Math.floor(r%3600/60),S=r%60;return l>0?`${l}:${String(u).padStart(2,"0")}:${String(S).padStart(2,"0")}`:`${u}:${String(S).padStart(2,"0")}`}function _(){const r=o.improvementTrend||[];if(r.length<2)return"stable";const u=r.slice(-5).map(d=>d.score).filter(d=>d!=null);if(u.length<2)return"stable";const S=u.slice(0,Math.ceil(u.length/2)),O=u.slice(Math.floor(u.length/2)),x=S.reduce((d,y)=>d+y,0)/S.length,j=(O.reduce((d,y)=>d+y,0)/O.length-x)/x*100;return j>5?"improving":j<-5?"declining":"stable"}function X(){const r=[];o.totalSessions<5&&r.push({type:"beginner",title:"新手建议",content:"建议每天进行15-20分钟的训练，保持规律性有助于提高效果。"}),o.completionRate<80&&r.push({type:"completion",title:"完成率提升",content:"尝试降低难度或延长训练时间，提高训练完成率。"}),o.averageScore<60&&r.push({type:"performance",title:"成绩提升",content:"建议从基础难度开始，逐步提高训练强度。"});const l=_();return l==="declining"?r.push({type:"trend",title:"状态调整",content:"最近表现有所下降，建议适当休息或调整训练方式。"}):l==="improving"&&r.push({type:"trend",title:"保持状态",content:"最近表现不错，继续保持当前的训练节奏！"}),r}async function Z(r=!0){try{if(!r){const u=await I(t);Object.assign(i,u),await A(t,i)}return Object.assign(o,{totalSessions:0,totalTime:0,bestScore:null,averageScore:null,lastSession:null,completionRate:0,improvementTrend:[],achievements:[],weeklyProgress:[],monthlyProgress:[]}),await N(t,o),console.log(`${t}模块数据已重置`),!0}catch(l){return console.error(`重置${t}模块数据失败:`,l),!1}}oe(()=>{D()}),re(()=>{v(),c.value&&T({completed:!1})});function ee(r){b.value=r,M()}function te(){T({completed:!0})}return{isLoading:e,settings:i,stats:o,currentSession:s,isTraining:c,isPaused:a,selectedMode:b,trainingTime:C,trainingProgress:P,formattedStats:U,sessionProgress:B,canStartTraining:z,canPauseTraining:F,canResumeTraining:H,initializeModule:D,updateSettings:L,startTraining:ee,startTrainingSession:M,pauseTraining:V,resumeTraining:Y,stopTraining:te,endTrainingSession:T,cancelTrainingSession:G,updateSessionData:J,addError:W,setSessionScore:q,markSessionCompleted:Q,formatDuration:k,getTrainingSuggestions:X,resetModuleData:Z}}function fe(t){const{settings:n,updateSettings:e}=t;return{settings:n,updateSettings:e,toggleSoundEffects:()=>{e({soundEffects:!n.soundEffects})},toggleVibration:()=>{e({vibration:!n.vibration})},toggleShowProgress:()=>{e({showProgress:!n.showProgress})},toggleAutoNext:()=>{e({autoNext:!n.autoNext})},setTheme:g=>{e({theme:g})}}}function me(t){const{stats:n,formattedStats:e}=t,i=f(()=>{const s=n.weeklyProgress||[],c=n.monthlyProgress||[];return{weekly:s.map(a=>({label:a.week,sessions:a.sessions,averageScore:a.averageScore,totalTime:a.totalTime})),monthly:c.map(a=>({label:a.month,sessions:a.sessions,averageScore:a.averageScore,totalTime:a.totalTime}))}}),o=f(()=>{const s=n.achievements||[],c=6;return{unlocked:s.length,total:c,percentage:s.length/c*100,recent:s.slice(-3)}});return{stats:n,formattedStats:e,getChartData:i,getAchievementProgress:o}}export{me as a,fe as b,de as u};
