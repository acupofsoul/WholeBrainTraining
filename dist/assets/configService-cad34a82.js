import{o as c,a as u,b as o,t as y,f as b,F as T,h as w,g as _,n as C,l as L,L as m}from"./index-e0b54b24.js";import{_ as I}from"./_plugin-vue_export-helper-c27b6911.js";const E={name:"SettingsModal",props:{visible:{type:Boolean,default:!1},title:{type:String,default:"设置"},titleIcon:{type:String,default:"⚙️"},sections:{type:Array,required:!0},modelValue:{type:Object,required:!0},defaultValues:{type:Object,default:()=>({})}},emits:["update:modelValue","close","save","reset"],methods:{updateSetting(d,e){const t={...this.modelValue};typeof this.defaultValues[d]=="number"?e=Number(e):typeof this.defaultValues[d]=="boolean"&&(e=!!e),t[d]=e,this.$emit("update:modelValue",t)},formatValue(d,e){return d.unit?`${e}${d.unit}`:d.formatter?d.formatter(e):e},closeModal(){this.$emit("close")},saveSettings(){this.$emit("save",this.modelValue),this.closeModal()},resetToDefaults(){this.$emit("reset"),this.$emit("update:modelValue",{...this.defaultValues})},handleOverlayClick(){this.closeModal()}}},x={class:"modal-header"},N={class:"modal-title"},B={class:"title-icon"},D={class:"modal-content"},A={class:"settings-sections"},V={key:0,class:"section-title"},O={key:0,class:"section-icon"},K={class:"section-content"},G={class:"setting-label"},M=["for"],F={key:0,class:"setting-description"},R={class:"setting-control"},z={key:0,class:"range-control"},P=["id","min","max","step","value","onInput","disabled"],j={class:"range-value"},U=["id","value","onChange","disabled"],Y=["value"],q={key:2,class:"switch-control"},H=["id","checked","onChange","disabled"],Q=["id","min","max","step","value","onInput","disabled"],J=["id","value","onInput","disabled","placeholder"],Z={key:5,class:"color-control"},W=["id","value","onInput","disabled"],X={class:"color-value"},$={class:"modal-footer"},ee={class:"footer-actions"};function te(d,e,t,s,a,n){return t.visible?(c(),u("div",{key:0,class:"settings-modal-overlay",onClick:e[5]||(e[5]=(...r)=>n.handleOverlayClick&&n.handleOverlayClick(...r))},[o("div",{class:"settings-modal",onClick:e[4]||(e[4]=L(()=>{},["stop"]))},[o("div",x,[o("h3",N,[o("span",B,y(t.titleIcon),1),b(" "+y(t.title),1)]),o("button",{class:"close-btn",onClick:e[0]||(e[0]=(...r)=>n.closeModal&&n.closeModal(...r))},e[6]||(e[6]=[o("span",{class:"close-icon"},"×",-1)]))]),o("div",D,[o("div",A,[(c(!0),u(T,null,w(t.sections,r=>(c(),u("div",{key:r.id,class:"settings-section"},[r.title?(c(),u("h4",V,[r.icon?(c(),u("span",O,y(r.icon),1)):_("",!0),b(" "+y(r.title),1)])):_("",!0),o("div",K,[(c(!0),u(T,null,w(r.settings,i=>(c(),u("div",{key:i.key,class:C(["setting-item",{"setting-disabled":i.disabled}])},[o("div",G,[o("label",{for:i.key},y(i.label),9,M),i.description?(c(),u("span",F,y(i.description),1)):_("",!0)]),o("div",R,[i.type==="range"?(c(),u("div",z,[o("input",{id:i.key,type:"range",min:i.min,max:i.max,step:i.step||1,value:t.modelValue[i.key],onInput:l=>n.updateSetting(i.key,l.target.value),disabled:i.disabled,class:"range-input"},null,40,P),o("span",j,y(n.formatValue(i,t.modelValue[i.key])),1)])):i.type==="select"?(c(),u("select",{key:1,id:i.key,value:t.modelValue[i.key],onChange:l=>n.updateSetting(i.key,l.target.value),disabled:i.disabled,class:"select-input"},[(c(!0),u(T,null,w(i.options,l=>(c(),u("option",{key:l.value,value:l.value},y(l.label),9,Y))),128))],40,U)):i.type==="switch"?(c(),u("label",q,[o("input",{id:i.key,type:"checkbox",checked:t.modelValue[i.key],onChange:l=>n.updateSetting(i.key,l.target.checked),disabled:i.disabled,class:"switch-input"},null,40,H),e[7]||(e[7]=o("span",{class:"switch-slider"},null,-1))])):i.type==="number"?(c(),u("input",{key:3,id:i.key,type:"number",min:i.min,max:i.max,step:i.step||1,value:t.modelValue[i.key],onInput:l=>n.updateSetting(i.key,l.target.value),disabled:i.disabled,class:"number-input"},null,40,Q)):i.type==="text"?(c(),u("input",{key:4,id:i.key,type:"text",value:t.modelValue[i.key],onInput:l=>n.updateSetting(i.key,l.target.value),disabled:i.disabled,placeholder:i.placeholder,class:"text-input"},null,40,J)):i.type==="color"?(c(),u("div",Z,[o("input",{id:i.key,type:"color",value:t.modelValue[i.key],onInput:l=>n.updateSetting(i.key,l.target.value),disabled:i.disabled,class:"color-input"},null,40,W),o("span",X,y(t.modelValue[i.key]),1)])):_("",!0)])],2))),128))])]))),128))])]),o("div",$,[o("button",{class:"btn btn-secondary",onClick:e[1]||(e[1]=(...r)=>n.resetToDefaults&&n.resetToDefaults(...r))},e[8]||(e[8]=[o("span",{class:"btn-icon"},"🔄",-1),b(" 恢复默认 ",-1)])),o("div",ee,[o("button",{class:"btn btn-outline",onClick:e[2]||(e[2]=(...r)=>n.closeModal&&n.closeModal(...r))}," 取消 "),o("button",{class:"btn btn-primary",onClick:e[3]||(e[3]=(...r)=>n.saveSettings&&n.saveSettings(...r))},e[9]||(e[9]=[o("span",{class:"btn-icon"},"💾",-1),b(" 保存设置 ",-1)]))])])])])):_("",!0)}const pe=I(E,[["render",te],["__scopeId","data-v-92a494c8"]]);const se={name:"SettingsButton",props:{text:{type:String,default:"设置"},variant:{type:String,default:"primary",validator:d=>["primary","secondary","outline"].includes(d)},floating:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},tooltip:String,customIcon:String,badge:[Number,Boolean],onClick:Function},emits:["click"],methods:{handleClick(d){this.disabled||this.loading||(this.$emit("click",d),this.onClick&&this.onClick(d))}}},ie=["disabled","title"],ne={class:"button-icon"},ae={key:0,width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},re=["innerHTML"],oe={key:0,class:"button-text"},le={key:1,class:"button-loading"},ce={key:2,class:"button-badge"};function ue(d,e,t,s,a,n){return c(),u("button",{class:C(["settings-button",{"button-floating":t.floating,"button-compact":t.compact,"button-primary":t.variant==="primary","button-secondary":t.variant==="secondary","button-outline":t.variant==="outline"}]),onClick:e[0]||(e[0]=(...r)=>n.handleClick&&n.handleClick(...r)),disabled:t.disabled,title:t.tooltip||"设置参数"},[o("span",ne,[t.customIcon?(c(),u("span",{key:1,innerHTML:t.customIcon},null,8,re)):(c(),u("svg",ae,e[1]||(e[1]=[o("path",{d:"M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"},null,-1)])))]),!t.compact&&t.text?(c(),u("span",oe,y(t.text),1)):_("",!0),t.loading?(c(),u("span",le,e[2]||(e[2]=[o("svg",{class:"loading-spinner",width:"16",height:"16",viewBox:"0 0 24 24"},[o("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"2",fill:"none","stroke-dasharray":"31.416","stroke-dashoffset":"31.416"},[o("animate",{attributeName:"stroke-dasharray",dur:"2s",values:"0 31.416;15.708 15.708;0 31.416",repeatCount:"indefinite"}),o("animate",{attributeName:"stroke-dashoffset",dur:"2s",values:"0;-15.708;-31.416",repeatCount:"indefinite"})])],-1)]))):_("",!0),t.badge?(c(),u("span",ce,y(typeof t.badge=="number"?t.badge:""),1)):_("",!0)],10,ie)}const Se=I(se,[["render",ue],["__scopeId","data-v-e21d1f18"]]),de=(d,e)=>{let t;return function(...a){const n=()=>{clearTimeout(t),d(...a)};clearTimeout(t),t=setTimeout(n,e)}},h={USER_SETTINGS:"user_settings_v2",TRAINING_SETTINGS:"training_settings_v2",ABILITY_TEST_SETTINGS:"ability_test_settings_v2",GLOBAL_SETTINGS:"global_settings_v2",SETTINGS_BACKUP:"settings_backup_v2",SETTINGS_VERSION:"settings_version",LAST_SYNC_TIME:"last_sync_time"},p="2.0.0",S={TRAINING:"training",ABILITY_TEST:"ability_test",GLOBAL:"global",USER:"user"};class fe{constructor(){this.listeners=new Map,this.syncQueue=new Set,this.isInitialized=!1,this.lastSyncTime=null,this.debouncedSave=de(this._performSave.bind(this),500),this.init()}async init(){try{await this._checkVersionCompatibility(),this.lastSyncTime=await m.getItem(h.LAST_SYNC_TIME),await this._createAutoBackup(),this.isInitialized=!0,console.log("设置持久化服务初始化完成")}catch(e){console.error("设置持久化服务初始化失败:",e),await this._restoreFromBackup()}}async saveSettings(e,t,s,a={}){const{immediate:n=!1,backup:r=!0,notify:i=!0}=a;try{const l=this._getSettingsKey(e),f=await this._getSettings(l)||{};return t?f[t]=s:Object.assign(f,s),f._metadata={lastModified:Date.now(),version:p,category:e},n?await this._performSave(l,f):(this.syncQueue.add({key:l,data:f}),this.debouncedSave()),r&&await this._createSettingsBackup(e,f),i&&this._notifyListeners(e,t,s),f}catch(l){throw console.error("保存设置失败:",l),new Error(`保存设置失败: ${l.message}`)}}async getSettings(e,t=null,s=null){try{const a=this._getSettingsKey(e),n=await this._getSettings(a);return n?this._validateSettings(n)?t?n[t]!==void 0?n[t]:s:n:(console.warn("设置数据损坏，尝试从备份恢复"),await this._restoreFromBackup(e,t,s)):s}catch(a){return console.error("获取设置失败:",a),s}}async resetSettings(e,t=null){try{const s=this._getSettingsKey(e);if(t){const a=await this._getSettings(s)||{};delete a[t],await this._performSave(s,a)}else await m.removeItem(s);this._notifyListeners(e,t,null)}catch(s){throw console.error("重置设置失败:",s),s}}async exportAllSettings(){try{const e={version:p,timestamp:Date.now(),settings:{}};for(const t of Object.values(S)){const s=this._getSettingsKey(t),a=await this._getSettings(s);a&&(e.settings[t]=a)}return e}catch(e){throw console.error("导出设置失败:",e),e}}async importSettings(e,t={}){const{merge:s=!0,backup:a=!0,validate:n=!0}=t;try{if(n&&!this._validateImportData(e))throw new Error("导入数据格式无效");a&&await this._createFullBackup("pre_import");for(const[r,i]of Object.entries(e.settings)){const l=this._getSettingsKey(r);if(s){const v={...await this._getSettings(l)||{},...i};await this._performSave(l,v)}else await this._performSave(l,i);this._notifyListeners(r,null,i)}console.log("设置导入完成")}catch(r){throw console.error("导入设置失败:",r),r}}addListener(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{const s=this.listeners.get(e);s&&s.delete(t)}}async cleanupExpiredData(e=30){try{const t=Date.now()-e*24*60*60*1e3,s=await m.keys();for(const a of s)a.includes("backup_")&&a.includes("_")&&parseInt(a.split("_").pop())<t&&await m.removeItem(a);console.log("过期数据清理完成")}catch(t){console.error("清理过期数据失败:",t)}}async getStorageStats(){try{const e={totalKeys:0,settingsKeys:0,backupKeys:0,lastSyncTime:this.lastSyncTime,version:p},t=await m.keys();e.totalKeys=t.length;for(const s of t)Object.values(h).includes(s)?e.settingsKeys++:s.includes("backup_")&&e.backupKeys++;return e}catch(e){return console.error("获取存储统计失败:",e),null}}_getSettingsKey(e){switch(e){case S.TRAINING:return h.TRAINING_SETTINGS;case S.ABILITY_TEST:return h.ABILITY_TEST_SETTINGS;case S.GLOBAL:return h.GLOBAL_SETTINGS;case S.USER:return h.USER_SETTINGS;default:throw new Error(`未知的设置分类: ${e}`)}}async _getSettings(e){return await m.getItem(e)}async _performSave(e,t){if(typeof e=="object"){for(const s of this.syncQueue)await m.setItem(s.key,s.data);this.syncQueue.clear()}else await m.setItem(e,t);this.lastSyncTime=Date.now(),await m.setItem(h.LAST_SYNC_TIME,this.lastSyncTime)}async _checkVersionCompatibility(){const e=await m.getItem(h.SETTINGS_VERSION);e?e!==p&&(await this._migrateSettings(e,p),await m.setItem(h.SETTINGS_VERSION,p)):await m.setItem(h.SETTINGS_VERSION,p)}async _migrateSettings(e,t){console.log(`迁移设置数据: ${e} -> ${t}`),await this._createFullBackup("pre_migration")}async _createAutoBackup(){try{const e=await this.exportAllSettings(),t=`${h.SETTINGS_BACKUP}_auto_${Date.now()}`;await m.setItem(t,e)}catch(e){console.error("创建自动备份失败:",e)}}async _createSettingsBackup(e,t){try{const s=`${h.SETTINGS_BACKUP}_${e}_${Date.now()}`;await m.setItem(s,t)}catch(s){console.error("创建设置备份失败:",s)}}async _createFullBackup(e=""){try{const t=await this.exportAllSettings(),s=`${h.SETTINGS_BACKUP}_full_${e}_${Date.now()}`;await m.setItem(s,t)}catch(t){console.error("创建完整备份失败:",t)}}async _restoreFromBackup(e=null,t=null,s=null){var a,n,r;try{const l=(await m.keys()).filter(f=>f.includes(h.SETTINGS_BACKUP)).filter(f=>!e||f.includes(e)).sort((f,v)=>{const k=parseInt(f.split("_").pop());return parseInt(v.split("_").pop())-k});if(l.length>0){const f=await m.getItem(l[0]);return e&&t?((n=(a=f.settings)==null?void 0:a[e])==null?void 0:n[t])||s:e?((r=f.settings)==null?void 0:r[e])||s:(await this.importSettings(f,{merge:!1,backup:!1}),f)}return s}catch(i){return console.error("从备份恢复失败:",i),s}}_validateSettings(e){if(!e||typeof e!="object")return!1;if(e._metadata){const{lastModified:t,version:s}=e._metadata;if(!t||!s)return!1}return!0}_validateImportData(e){return!(!e||typeof e!="object"||!e.version||!e.settings)}_notifyListeners(e,t,s){const a=this.listeners.get(e);if(a)for(const n of a)try{n({category:e,key:t,value:s,timestamp:Date.now()})}catch(r){console.error("监听器回调执行失败:",r)}}}const be=new fe,g={imageFlash:{flashDuration:1e3,intervalDuration:500,imageCount:10,imageSize:"medium",mode:"sequence",difficulty:"normal",showProgress:!0,showTimer:!0,showScore:!0,enableSound:!0,enableVibration:!1,showCorrectAnswer:!0,autoStart:!1,pauseOnError:!1,adaptiveDifficulty:!1},articleFlash:{flashDuration:2e3,intervalDuration:1e3,wordsPerFlash:5,articleLength:"medium",fontSize:16,fontFamily:"sans-serif",mode:"linear",difficulty:"normal",showProgress:!0,showTimer:!0,showScore:!0,highlightKeywords:!0,enableComprehension:!0,questionCount:3,questionType:"multiple",autoStart:!1,pauseOnError:!1,adaptiveSpeed:!1},expandVision:{gridSize:5,targetCount:3,displayDuration:2e3,targetColor:"#667eea",backgroundColor:"#f8f9fa",targetShape:"circle",mode:"static",difficulty:"normal",showGrid:!0,showProgress:!0,showTimer:!0,showScore:!0,enableSound:!0,enableVibration:!1,showTrajectory:!1,autoStart:!1,randomPosition:!0,adaptiveDifficulty:!1},attention:{focusDuration:3e4,targetSize:"medium",distractorCount:5,attentionType:"selective",targetType:"color",targetColor:"#667eea",backgroundColor:"#f8f9fa",distractorOpacity:.6,mode:"focus",difficulty:"normal",showProgress:!0,showTimer:!0,showScore:!0,showInstructions:!0,enableSound:!0,enableVibration:!1,realTimeFeedback:!0,autoStart:!1,adaptiveSpeed:!1,eyeTrackingMode:!1},visualSearchTest:{testDuration:3e5,itemCount:20,targetCount:3,itemSize:"medium",targetColor:"#667eea",backgroundColor:"#f8f9fa",testType:"conjunction",difficulty:"normal",showProgress:!0,showTimer:!0,showInstructions:!0,recordEyeMovement:!1,recordReactionTime:!0,recordAccuracy:!0,randomizeOrder:!0,adaptiveDifficulty:!1},attentionTest:{testDuration:6e5,trialCount:50,attentionType:"sustained",stimulusType:"visual",stimulusSize:"medium",targetColor:"#667eea",backgroundColor:"#f8f9fa",testType:"cpt",difficulty:"normal",showProgress:!0,showTimer:!0,showInstructions:!0,recordReactionTime:!0,recordAccuracy:!0,recordLapses:!0,randomizeISI:!0,adaptiveDifficulty:!1},detailObservationTest:{testDuration:9e5,imageCount:15,observationTime:3e4,imageType:"complex",imageSize:"large",detailLevel:"high",testType:"comparison",difficulty:"normal",showProgress:!0,showTimer:!0,showInstructions:!0,allowZoom:!0,questionCount:5,questionType:"multiple",recordViewTime:!0,recordAccuracy:!0,recordDetailLevel:!0,randomizeOrder:!0,adaptiveDifficulty:!1},global:{theme:"light",language:"zh-CN",fontSize:"medium",autoSave:!0,saveInterval:3e4,dataRetention:30,enableNotifications:!0,soundVolume:.7,vibrationIntensity:.5,enableAnimations:!0,highPerformanceMode:!1,debugMode:!1}},me={imageFlash:{flashDuration:{min:100,max:1e4,type:"number"},intervalDuration:{min:0,max:5e3,type:"number"},imageCount:{min:1,max:100,type:"number"},imageSize:{values:["small","medium","large"],type:"string"}},articleFlash:{flashDuration:{min:500,max:1e4,type:"number"},intervalDuration:{min:0,max:5e3,type:"number"},wordsPerFlash:{min:1,max:20,type:"number"},fontSize:{min:12,max:24,type:"number"}},expandVision:{gridSize:{min:3,max:10,type:"number"},targetCount:{min:1,max:10,type:"number"},displayDuration:{min:500,max:1e4,type:"number"}},attention:{focusDuration:{min:5e3,max:3e5,type:"number"},distractorCount:{min:0,max:20,type:"number"}}};class he{constructor(){this.configs={},this.listeners=new Map,this.loadConfigs()}loadConfigs(){try{const e=localStorage.getItem("brainTraining_configs");e?this.configs={...g,...JSON.parse(e)}:this.configs={...g}}catch(e){console.warn("加载配置失败，使用默认配置:",e),this.configs={...g}}}saveConfigs(){try{return localStorage.setItem("brainTraining_configs",JSON.stringify(this.configs)),!0}catch(e){return console.error("保存配置失败:",e),!1}}getConfig(e,t=null){return this.configs[e]?t?this.configs[e][t]:{...this.configs[e]}:(console.warn(`模块 ${e} 的配置不存在`),t?void 0:{})}setConfig(e,t,s=null){this.configs[e]||(this.configs[e]={});let a={};typeof t=="object"?a=t:a[t]=s;for(const[r,i]of Object.entries(a))if(!this.validateConfig(e,r,i))return console.warn(`配置验证失败: ${e}.${r} = ${i}`),!1;Object.assign(this.configs[e],a);const n=this.saveConfigs();return n&&this.notifyListeners(e,a),n}resetConfig(e,t=null){if(!g[e])return console.warn(`模块 ${e} 的默认配置不存在`),!1;if(t)if(g[e][t]!==void 0)this.configs[e][t]=g[e][t];else return console.warn(`配置 ${e}.${t} 不存在`),!1;else this.configs[e]={...g[e]};const s=this.saveConfigs();if(s){const a=t?{[t]:this.configs[e][t]}:this.configs[e];this.notifyListeners(e,a)}return s}getDefaultConfig(e,t=null){return g[e]?t?g[e][t]:{...g[e]}:t?void 0:{}}validateConfig(e,t,s){const a=me[e];if(!a||!a[t])return!0;const n=a[t];return!(n.type&&typeof s!==n.type||n.type==="number"&&(n.min!==void 0&&s<n.min||n.max!==void 0&&s>n.max)||n.values&&!n.values.includes(s))}addListener(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{const s=this.listeners.get(e);s&&(s.delete(t),s.size===0&&this.listeners.delete(e))}}notifyListeners(e,t){const s=this.listeners.get(e);s&&s.forEach(a=>{try{a(t,this.configs[e])}catch(n){console.error("配置监听器执行失败:",n)}})}exportConfigs(e=null){if(e){const t={};return e.forEach(s=>{this.configs[s]&&(t[s]={...this.configs[s]})}),t}return{...this.configs}}importConfigs(e,t=!0){try{if(t)for(const[a,n]of Object.entries(e))typeof n=="object"&&(this.configs[a]={...this.configs[a],...n});else this.configs={...g,...e};const s=this.saveConfigs();if(s)for(const a of Object.keys(e))this.notifyListeners(a,this.configs[a]);return s}catch(s){return console.error("导入配置失败:",s),!1}}clearConfigs(){try{localStorage.removeItem("brainTraining_configs"),this.configs={...g};for(const e of this.listeners.keys())this.notifyListeners(e,this.configs[e]);return!0}catch(e){return console.error("清除配置失败:",e),!1}}}const ve=new he;export{pe as S,Se as a,S as b,ve as c,be as s};
